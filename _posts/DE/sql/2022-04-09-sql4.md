---
title:  "[PostgreSQL] Group byì™€ ì§‘ê³„ í•¨ìˆ˜" 

categories:
  -  SQL
tags:
  - [Data Engineering, SQL]

toc: true
toc_sticky: true

date: 2022-04-09
last_modified_at: 2022-04-09
---

ì¸í”„ëŸ°ì— ìˆëŠ” ê¶Œì² ë¯¼ë‹˜ì˜ **[ë°ì´í„° ë¶„ì„ SQL Fundamentals](https://www.inflearn.com/course/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B6%84%EC%84%9D-sql-%ED%8E%80%EB%8D%94%EB%A9%98%ED%83%88/dashboard)** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤.
{: .notice--warning}

<br>

# ğŸ˜ Group by

![groupby](https://user-images.githubusercontent.com/96368476/162585354-202b397b-32f0-417f-828a-658def627f0f.jpg){: width="60%" height="70%" .align-center}

- Groupí™” í•œ ë°ì´í„°ë¥¼ í† ëŒ€ë¡œ ì§‘ê³„ í•¨ìˆ˜(Aggregation function)ì™€ í•¨ê»˜ ì‚¬ìš©
- Group byì— ì‚¬ìš©í•œ columnì´ primary key ì—­í•  ê°€ëŠ¥

<br>

``` sql
SELECT
    genre,
    SUM(qty) AS total
FROM MOVIE
GROUP BY genre
```

<br>


## GROUPING SET

``` sql
SELECT *
FROM TABLE1
GROUP BY
GROUPING SETS
(
  (COL1),
  (COL2),
  (COL3)
)
```

- (GROUP BY COL1) UNION ALL (GROUP BY COL2) UNION ALL (GROUP BY COL3)ì™€ ê°™ìŒ
- GORUPING í•¨ìˆ˜ëŠ” í•´ë‹¹ í–‰ ê¸°ì¤€ columnì´ ì§‘ê³„ì— ì‚¬ìš©ë˜ì—ˆìœ¼ë©´ 0, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 1ì„ ë¦¬í„´í•¨
- ì´ë¥¼ í™œìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ê°€ê³µí•˜ê¸° ì¢‹ìŒ

<br>

> [ê°œí‚¤ìš°ëŠ” ê°œë°œì](https://dog-developers.tistory.com/151?category=896105) ë‹˜ì˜ ë¸”ë¡œê·¸ë¥¼ ì°¸ê³ í–ˆìŠµë‹ˆë‹¤.

``` sql
SELECT
	CASE
		WHEN GROUPING(BRAND) = 0 AND GROUPING(SEGMENT) = 0 THEN 'ë¸Œëœë“œë³„+ë“±ê¸‰ë³„'
		WHEN GROUPING(BRAND) = 0 AND GROUPING(SEGMENT) = 1 THEN 'ë¸Œëœë“œë³„'
		WHEN GROUPING(BRAND) = 1 AND GROUPING(SEGMENT) = 0 THEN 'ë“±ê¸‰ë³„'
		WHEN GROUPING(BRAND) = 1 AND GROUPING(SEGMENT) = 1 THEN 'ì „ì²´ì§‘ê³„'
		ELSE ''
	END AS "ì§‘ê³„ê¸°ì¤€",
	BRAND,
	SEGMENT,
	SUM(QUANTITY)
FROM
	SALES
GROUP BY
	GROUPING SETS ( (BRAND,
	SEGMENT),
	(BRAND),
	(SEGMENT),
	() )
ORDER BY
	BRAND,
	SEGMENT
```

<br>

![grouping](https://user-images.githubusercontent.com/96368476/162586522-3aef9e1e-58e0-498b-9e6b-9181b6422a4a.png){: width="50%" height="60%" .align-center}


<br>



## Having

``` sql
SELECT
    CUSTOMER_ID,
    SUM(AMOUNT) AS AMOUNT_SUM
FROM PAYMENT
GROUP BY CUSTOMER_ID
HAVING SUM(AMOUNT) > 200 -- í•„í„°ë§
ORDER BY CUSTOMER_ID; -- ì •ë ¬
```

- GROUP BY í›„ í•„í„°ë§


<br>


## Aggregation Function

| Function | Description |
|:-:|:-:|
| Count | ë°ì´í„° ê±´ìˆ˜ ë¦¬í„´ |
| Count(distinct col) | Group byì— ì‚¬ìš©í•œ column ê°’ ì¤‘ ì¤‘ë³µì„ ì œì™¸í•˜ê³  count |
| Sum(col) | ì´ í•© ë¦¬í„´ |
| Min(col) | ìµœì†Ÿê°’ ë¦¬í„´ |
| Max(col) | ìµœëŒ“ê°’ ë¦¬í„´ |
| Avg(col) | í‰ê· ê°’ ë¦¬í„´ |

- **<span style="color:red">NULLê°’ì€ ì§‘ê³„ì—ì„œ ì œì™¸í•¨</span>**
  - ì§‘ê³„í•˜ê³  ì‹¶ë‹¤ë©´ Coalesce í•¨ìˆ˜ ì´ìš©
- Min, Maxì˜ ê²½ìš° date, timestamp ë“±ì˜ íƒ€ì…ì—ì„œë„ ê°€ëŠ¥


<br>


## ì‘ìš© - í–‰ ë ˆë²¨ ë°ì´í„° ì—´ ë ˆë²¨ë¡œ ì „í™˜í•˜ê¸°

| Year | Month | Revenue |
|:-:|:-:|:-:|
| 2016 | 1 | 10 |
| 2016 | 2 | 25 |
| 2016 | 3 | 40 |
| 2016 | ... | ... |
| 2016 | 12 | 78 |

<br>

``` sql
SELECT
    Year, sum(revenue) as Year_rev,
    sum(case when Month = 1 then revenue end) as January,
    sum(case when Month = 2 then revenue end) as February,
    ...
    sum(case when Month = 12 then revenue end) as December,
FROM sales
GROUP BY Year
```

<br>

| Year | Year_rev | January | February | ... | December |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 2016 | 450 | 10 | 25 | ... | 78 |


<br>


## ROLLUP

``` sql
SELECT 
    Type, Store, sum(Number) as Number
FROM Pet
GROUP BY ROLLUP(Type, Store)
ORDER BY 1,2;
```

![rollup](https://user-images.githubusercontent.com/96368476/162589485-f72791de-6875-428a-8cf2-616246316c89.jpg){: width="50%" height="60%" .align-center}

- ê³„ì¸µì ì¸ ë°©ì‹ìœ¼ë¡œ Group by ì§„í–‰ (íŒŒë¼ë¯¸í„° ìˆœì„œ ê¸°ì¤€)
- n+1 ë²ˆ Group by ìˆ˜í–‰ (n: rollupì˜ íŒŒë¼ë¯¸í„° ê°¯ìˆ˜)

<br>


## CUBE

``` sql
SELECT 
    Type, Store, sum(Number) as Number
FROM Pet
GROUP BY CUBE(Type, Store)
ORDER BY 1,2;
```

![cube](https://user-images.githubusercontent.com/96368476/162589486-7ee390da-990e-4222-b138-f558efe28e68.jpg){: width="50%" height="60%" .align-center}

- íŒŒë¼ë¯¸í„°ë³„ ë™ë“±í•œ ê¸°ì¤€ìœ¼ë¡œ Group by ì§„í–‰
- 2^n ë²ˆ Group by ìˆ˜í–‰ (n: cubeì˜ íŒŒë¼ë¯¸í„° ê°¯ìˆ˜)




<br>

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}