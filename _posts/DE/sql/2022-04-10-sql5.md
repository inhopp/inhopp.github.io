---
title:  "[PostgreSQL] Analytic Functions (Window Functions)" 

categories:
  -  SQL
tags:
  - [Data Engineering]

toc: true
toc_sticky: true

date: 2022-04-10
last_modified_at: 2022-04-10
---

ì¸í”„ëŸ°ì— ìˆëŠ” ê¶Œì² ë¯¼ë‹˜ì˜ **[ë°ì´í„° ë¶„ì„ SQL Fundamentals](https://www.inflearn.com/course/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B6%84%EC%84%9D-sql-%ED%8E%80%EB%8D%94%EB%A9%98%ED%83%88/dashboard)** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤. <br>[Dev.log](https://devdhjo.github.io/sqld/2019/11/27/database-sqld-023.html) ë¸”ë¡œê·¸ ê¸€ì„ ì°¸ê³ í–ˆìŠµë‹ˆë‹¤.
{: .notice--warning}

<br>

# ğŸ˜ Analytic SQL vs Group by + ì§‘ê³„

![window2](https://user-images.githubusercontent.com/96368476/162609283-1a592031-aece-438c-a432-ef45c867988f.png){: width="60%" height="70%" .align-center}

![window1](https://user-images.githubusercontent.com/96368476/162609282-0e8289c7-8605-4ca1-837c-9bbcabdbf924.png){: width="60%" height="70%" .align-center}

- Group byëŠ” ë°ì´í„°ë¥¼ í•©ì¹˜ê³  ë‚œ í›„ ì§‘ê³„ (ì›ë³¸ ë°ì´í„° ì§‘í•© ë³€ê²½)
- Analytic SQLì€ ì›ë³¸ ë°ì´í„° ì§‘í•©ì„ ìœ ì§€í•˜ë©´ì„œ ì§‘ê³„
- How? Winodw boxê°€ í–‰ ë‹¨ìœ„ë¡œ ì›€ì§ì´ë©´ì„œ ì§‘ê³„
- Group byì™€ í•¨ê»˜ ì‚¬ìš© ë¶ˆê°€

<br>

``` sql
SELECT
    window_function(column) as name
OVER (
    PARTITION BY ...       -- Partition column
    ORDER BY ...           -- Sorting column
    RANGE(ROWS) ...        -- Window range
)
FROM Table1, 
```


<br>


## Window Function ì¢…ë¥˜

- ìˆœìœ„ í•¨ìˆ˜
    - Rank, Dense_Rank, Row_Number
- ë¹„ìœ¨ í•¨ìˆ˜
    - Percent_Rank, Cume_Dist, ntile, Ratio_to_Report
- ì—­ ë¶„ìœ„ í•¨ìˆ˜
    - Percentile_Cont, Percentile_Disc
- ì§‘ê³„ í•¨ìˆ˜
    - Sum, Max, Min, Avg, Count
- í–‰ ìˆœì„œ í•¨ìˆ˜ (window ë²”ìœ„)
    - First_Value, Last_Value, Lag, Lead

<br>

## ìˆœìœ„ í•¨ìˆ˜

| ìˆœìœ„ í•¨ìˆ˜ | Description |
|:-:|:-:|
| Rank | ê³µë™ìˆœìœ„ ìˆì„ ê²½ìš° ë°€ë¦¼ <br>ex) 1, 2, 2, 4 |
| Dense_Rank | ê³µë™ìˆœìœ„ ìˆë”ë¼ë„ ë°€ë¦¬ì§€ ì•ŠìŒ <br>ex) 1, 2, 2, 3|
| Row_Number | ê³µë™ìˆœìœ„ ìˆë”ë¼ë„ ë¬´ì¡°ê±´ ê³ ìœ  ë²ˆí˜¸ <br>ex) 1, 2, 3, 4 |

<br>

``` sql
SELECT
    JOB, ENAME, SAL,
    RANK() OVER (ORDER BY SAL DESC) ALL_RANK,
    RANK() OVER (PARTITION BY JOB ORDER BY SAL DESC) JOB_RANK
FROM EMP;
```

![ex1](https://user-images.githubusercontent.com/96368476/162611102-449911b1-f534-480d-91c2-fe525942ec7f.jpg){: width="40%" height="50%"}



<br>


## ë¹„ìœ¨ í•¨ìˆ˜

| ë¹„ìœ¨ í•¨ìˆ˜ | Description |
|:-:|:-:|
| Percent_Rank | ìˆœìœ„ë¥¼ 0~1 ê°’ìœ¼ë¡œ í‘œí˜„ <br>ex) ë°ì´í„° 3ê°œ â†’ 0, 0.5, 1 |
| Ratio_to_Report | íŒŒí‹°ì…˜ ë‚´ sumì— ëŒ€í•œ í˜„ì¬ ì»¬ëŸ¼ ê°’ ë°±ë¶„ìœ¨ |
| Cume_Dist | Accumulation Distribution : ëˆ„ì  ë°±ë¶„ìœ¨ |
| ntile(N) | Në¶„ìœ„ ê°’ |

<br>

``` sql
SELECT
    DEPTNO, ENAME, SAL,
    CUME_DIST() OVER (PARTITION BY DEPTNO ORDER BY SAL DESC) AS CUME_DIST
FROM EMP;
```

![ex2](https://user-images.githubusercontent.com/96368476/162611661-bbfe1218-f621-48bc-ad6e-0b1ec9261754.jpg){: width="40%" height="50%"}

<br>

``` sql
SELECT
    DEPTNO, ENAME, SAL,
    NTILE(4) OVER (ORDER BY SAL DESC) AS QUAR_TILE
FROM EMP;
```

![ex3](https://user-images.githubusercontent.com/96368476/162611663-1111c1d9-8150-484c-8390-6ae847433f28.jpg){: width="40%" height="50%"}



<br>



## ì—­ ë¶„ìœ„ í•¨ìˆ˜

| ë¹„ìœ¨ í•¨ìˆ˜ | Description |
|:-:|:-:|
| Percentile_Cont(N) | ë°ì´í„°ê°€ ì—°ì†ë¶„í¬ë¼ ê°€ì •.<br> [0~1] ì‚¬ì´ì˜ íŠ¹ì • ë¶„ìœ„ìˆ˜ì— í•´ë‹¹í•˜ëŠ” ê°’ ë°˜í™˜ |
| Percentile_Disc(N) | ë°ì´í„°ê°€ ì´ì‚°ë¶„í¬ë¼ ê°€ì •.<br> [0~1] ì‚¬ì´ì˜ íŠ¹ì • ë¶„ìœ„ìˆ˜ì— í•´ë‹¹í•˜ëŠ” ê°’ ë°˜í™˜ |

- ê²°ì¸¡ì¹˜ ì±„ìš¸ ë•Œ ìœ ìš©
- Percentile_Discì˜ ê²½ìš° ì—­ë¶„ìœ„ ê°’ì´ ë²”ìœ„ë¡œ ë‚˜ì˜¬ ë•Œ ê°€ì¥ ì‘ì€ ê°’ ë°˜í™˜
- postgreSQLì—ì„œëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œë„ ì‚¬ìš© ê°€ëŠ¥



<br>


## ì§‘ê³„ í•¨ìˆ˜

``` sql
SELECT 
    MGR, ENAME, HIREDATE, SAL,
    ROUND (AVG(SAL) OVER (PARTITION BY MGR ORDER BY HIREDATE ROWS BETWEEN 1 PERCEDING AND 1 FOLLOWING)) AS MGR_AVG
FROM EMP;
```

- PARTITION ë³„ë¡œ í˜„ì¬ ROW ê¸°ì¤€ ì´ì „ ROW 1ì¹¸, ì´í›„ ROW 1ì¹¸ (ì´ 3ì¹¸) ì‚¬ì´ì˜ í‰ê· 
- ì´ì „/ì´í›„ ROWê°€ ì—†ìœ¼ë©´ ì§‘ê³„ì—ì„œ ì œì™¸

![ex4](https://user-images.githubusercontent.com/96368476/162611930-c18e7388-0aa6-4db4-8740-0cefd64fc29f.jpg){: width="40%" height="50%" }


<br>


``` sql
SELECT
    ENAME, SAL,
    COUNT(*) OVER (ORDER BY SAL RANGE BETWEEN 50 PERCEDING AND 150 FOLLOWING) AS SIM_CNT
FROM EMP;
```

- í˜„ì¬ ROW ê¸°ì¤€ ê¸‰ì—¬ê°€ -50 ~ +150ì¸ ë°ì´í„° COUNT

![ex5](https://user-images.githubusercontent.com/96368476/162612059-3ede2d4d-ac10-417b-9524-7e6b528ca40f.jpg){: width="40%" height="50%"}



<br>


## í–‰ ìˆœì„œ í•¨ìˆ˜ (Window ë²”ìœ„)

| ìˆœìœ„ í•¨ìˆ˜ | Description |
|:-:|:-:|
| First_Value | íŒŒí‹°ì…˜ ë‚´ ê°€ì¥ ë¨¼ì € ë‚˜ì˜¨ ê°’ |
| Last_Value | íŒŒí‹°ì…˜ ë‚´ ê°€ì¥ ë§ˆì§€ë§‰ì— ë‚˜ì˜¨ ê°’ |
| Lag(expr, [offset] [default]) | í˜„ì¬ row ê¸°ì¤€ ì´ì „ (offset) rowì˜ ê°’ <br> offset : ì´ì „ ëª‡ ì¹¸?  <br>default : NULLì¼ ê²½ìš° ëŒ€ì²´í•  ê°’.(ê¸°ë³¸ê°’:NULL)|
| Lead(expr, [offset] [default]) | í˜„ì¬ row ê¸°ì¤€ ë‹¤ìŒ (offset) rowì˜ ê°’ <br> offset : ë‹¤ìŒ ëª‡ ì¹¸?  <br>default : NULLì¼ ê²½ìš° ëŒ€ì²´í•  ê°’.(ê¸°ë³¸ê°’:NULL) |

- Order by ë°˜ë“œì‹œ í•„ìš”í•¨
- First/Last Value : windowì ˆ ìƒëµì‹œ range between unbounded preceding and current row ê°€ default ê°’
- Lag/Lead : default(NULL ëŒ€ì²´) ê°’ ì„¤ì • ì‹œ offsetê°’ 1ì´ë¼ë„ ëª…ì‹œí•´ì•¼ í•¨

<br>

``` sql
SELECT
    DEPTNO, ENAME, SAL,
    FIRST_VALUE(ENAME) OVER (PARTITION BY DEPTNO ORDER BY SAL DESC ROWS UNBOUNDED PRECEDING) AS DEPT_RICH
FROM EMP;
```
![ex6](https://user-images.githubusercontent.com/96368476/162613436-40f13dec-50b8-4d6a-9173-dcb4e4c46e24.jpg){: width="40%" height="50%"}

<br>

``` sql
--- ë°”ë¡œ ë‹¤ìŒì— ì…ì‚¬í•œ ì§ì›ì˜ ì…ì‚¬ ì¼
SELECT
    ENAME, HIREDATE
    LEAD(HIREDATE, 1) OVER (ORDER BY HIREDATE) AS "NEXT_HIRED"
FROM EMP;
```

![ex7](https://user-images.githubusercontent.com/96368476/162613435-3d771e02-8736-4f96-87aa-51289af65a0d.jpg){: width="40%" height="50%"}



<br>




## Windowì ˆ ROWS vs RANGE

![rowrange](https://user-images.githubusercontent.com/96368476/162614025-70e8fb88-8878-466e-a5d5-0dab116bdb9a.png){: width="70%" height="80%" .align-center}

- ROWS : ë°ì´í„°ì˜ ë¬¼ë¦¬ì ì¸ ìœ„ì¹˜. ëª¨ë“  í–‰ì´ 1ê°œì˜ í–‰ìœ¼ë¡œ ì¸ì‹
- RANGE : ë°ì´í„°ì˜ ë…¼ë¦¬ì ì¸ ìœ„ì¹˜. ê¸°ì¤€ ê°’ì´ ê°™ìœ¼ë©´ ê°™ì€ í–‰ìœ¼ë¡œ ì·¨ê¸‰.
- **<span style="color:red">ì§‘ê³„ ê¸°ì¤€ì´ ë‹¤ë¥´ë¯€ë¡œ ì£¼ì˜</span>**
- Windowì ˆ ìƒëµì‹œ default ê°’ :
    - **range between unbounded preceding and current row.**




<br>



## NULL ë‹¤ë£¨ê¸°

| PostgreSQL | ORACLE | MSSQL |
|:-:|:-:|:-:|
| Coalesce(col, default) | NVL(col, default) | ISNULL(col, default) | 

- Coalesce(col, default) : í•´ë‹¹ column ê°’ì´ NULLì¸ ê²½ìš° default ê°’ìœ¼ë¡œ ëŒ€ì²´
- ODER BY col Nulls first : NULLê°’ì„ ê°€ì¥ ìš°ì„  ìˆœìœ„ë¡œ
- ODER BY col Nulls last : NULLê°’ì„ ê°€ì¥ ë§ˆì§€ë§‰ ìˆœìœ„ë¡œ







<br>

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}