---
title:  "Mirror and Reflection (DepthStencil Test)" 

categories:
  -  Graphics
tags:
  - [DirectX]

toc: true
toc_sticky: true

date: 2023-09-24
last_modified_at: 2023-09-24
---


í™ì •ëª¨ë‹˜ì˜ **[ê·¸ë˜í”½ìŠ¤ ìƒˆì‹¹ì½”ìŠ¤](https://honglab.co.kr/)** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤.
{: .notice--warning}

<br>


# ğŸ¥ Mirror and Reflection

![1](https://github.com/inhopp/StyleGAN/assets/96368476/455630a7-7c24-47ce-829a-e9d394c1a0d1){: width="60%" height="70%"}

ê±°ìš¸ì— ë¹„ì¹˜ëŠ” ë¬¼ì²´ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•œ ë°©ë²• ì¤‘ ê°€ì¥ ë¨¼ì € ë– ì˜¤ë¥´ëŠ” ê²ƒì€ Ray Tracingì„ ì´ìš©í•œ ë°©ë²•ì¼ ê²ƒì´ë‹¤. í•˜ì§€ë§Œ Rasterizationì„ ì´ìš©í•˜ëŠ” ì „í†µì ì¸ ë Œë”ë§ íŒŒì´í”„ë¼ì¸ì—ì„œëŠ” ray tracingì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ì›”ë“œì— ì¡´ì¬í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ë“¤ì„ í†µì¨°ë¡œ ê±°ìš¸ ë’¤ì˜ ì„¸ìƒìœ¼ë¡œ ë°˜ì‚¬ì‹œí‚¨ ë’¤, Stencil Testë¥¼ ì´ìš©í•´ ê±°ìš¸ ì† ì„¸ìƒì„ ë³„ë„ë¡œ ë Œë”ë§ í•œë‹¤.

<br>

## Stencil Buffer

![stencil_buffer](https://github.com/inhopp/StyleGAN/assets/96368476/e9e85c43-b24d-497a-a796-24cb01b6fbec){: width="60%" height="70%"}

Stencil Bufferë€ Rasterize ì´í›„ 0/1 ê°’ìœ¼ë¡œ ë Œë”ë§ í•  ë¶€ë¶„ì„ í‘œê¸°í•´ì£¼ëŠ” ë²„í¼ì´ë‹¤. ê±°ìš¸ í‰ë©´ì˜ ê²½ìš° ê±°ìš¸ ì† ì „ì²´ ì›”ë“œë¥¼ ê·¸ë¦¬ëŠ” ê²ƒì€ ì•„ì£¼ í° ë‚­ë¹„ì´ë‹¤. ì´ëŸ´ ê²½ìš° Stencil Bufferë¥¼ ì´ìš©í•´ì—¬ ê±°ìš¸ì˜ í¬ê¸°ë§Œí¼ë§Œ ë Œë”ë§ì„ í•´ì£¼ë©´ ëœë‹¤.


<br>


# ğŸ¥ DepthStencil State

Stencil Bufferë¥¼ ì´ìš©í•œ ê±°ìš¸ì„ êµ¬í˜„í•  ê²½ìš° ì—¬ëŸ¬ê°€ì§€ì˜ DepthStencil Stateê°€ í•„ìš”í•˜ë‹¤.

- ê¸°ì¡´ Worldë¥¼ ë Œë”ë§í•˜ê¸° ìœ„í•œ DSS (Default State)
- Stencil Bufferì— ê±°ìš¸ ì˜ì—­ì„ í‘œê¸°í•´ì£¼ê¸° ìœ„í•œ DSS
- Stencil Testë¥¼ í†µê³¼í•œ ì˜¤ë¸Œì íŠ¸ë“¤ ë Œë”ë§í•˜ê¸° ìœ„í•œ DSS

<br>

## Default State

``` cpp
// DepthStencilView ìƒì„±

D3D11_TEXTURE2D_DESC desc;

// ...

desc.BindFlags = D3D11_BIND_DEPTH_STENCIL;
desc.Format = DXGI_FORMAT_D24_UNORM_S8_UINT;
ThrowIfFailed(m_device->CreateTexture2D(
    &desc, 0, m_depthStencilBuffer.GetAddressOf()));
ThrowIfFailed(m_device->CreateDepthStencilView(
    m_depthStencilBuffer.Get(), NULL, m_depthStencilView.GetAddressOf()));

```

- BindFlags : D3D11_BIND_DEPTH_STENCIL
- Format : DXGI_FORMAT_D24_UNORM_S8_UINT
  - ë³´í†µ ë²„í¼ë“¤ì€ í”½ì…€ ë‹¹ 32bit ë°ì´í„° ë“¤ê³  ìˆìŒ
  - ë©”ëª¨ë¦¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ (depth 24bit +  stencil 8bit)ë¥¼ í•¨ê»˜ ë“¤ê³ ë‹¤ë‹˜

<br>

``` cpp
// default DSS
D3D11_DEPTH_STENCIL_DESC dsDesc;
ZeroMemory(&dsDesc, sizeof(dsDesc));
dsDesc.DepthEnable = true;
dsDesc.DepthWriteMask = D3D11_DEPTH_WRITE_MASK_ALL; // ì“°ê¸° í‚¬ì§€ ë§ì§€
dsDesc.DepthFunc = D3D11_COMPARISON_LESS;
dsDesc.StencilEnable = false; // Stencil ë¶ˆí•„ìš”
dsDesc.StencilReadMask = D3D11_DEFAULT_STENCIL_READ_MASK;
dsDesc.StencilWriteMask = D3D11_DEFAULT_STENCIL_WRITE_MASK;
```

- DepthWriteMask :
  - D3D11_DEPTH_WRITE_MASK_ZERO : DepthStencil Buffer ì“°ê¸° ë„ê¸°
  - D3D11_DEPTH_WRITE_MASK_ALL : DepthStencil Buffer ì“°ê¸° ì¼œê¸°
- DepthFunc : D3D11_COMPARISON_LESS (ì‘ì„ ê²½ìš° í†µê³¼)
- StencilReadMask : D3D11_DEFAULT_STENCIL_READ_MASK;
- StencilWriteMask : D3D11_DEFAULT_STENCIL_WRITE_MASK;
  - 8bit ì „ë¶€ ì‚¬ìš© (0xFF) 
  - 0/1ì¸ë° ë³´í†µ ì´ë ‡ê²Œ ì“°ë‚˜..?


``` cpp
// ì•ë©´ì— ëŒ€í•´ì„œ ì–´ë–»ê²Œ ì‘ë™í• ì§€ ì„¤ì •
dsDesc.FrontFace.StencilFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilPassOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilFunc = D3D11_COMPARISON_ALWAYS;

// ë’·ë©´ì— ëŒ€í•´ ì–´ë–»ê²Œ ì‘ë™í• ì§€ ì„¤ì • (ë’·ë©´ë„ ê·¸ë¦´ ê²½ìš°)
dsDesc.BackFace.StencilFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.BackFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.BackFace.StencilPassOp = D3D11_STENCIL_OP_REPLACE;
dsDesc.BackFace.StencilFunc = D3D11_COMPARISON_ALWAYS;

ThrowIfFailed(
        m_device->CreateDepthStencilState(&dsDesc,  m_drawDSS.GetAddressOf()));
```

- StencilPassOp : depth, stencil ë‘˜ ë‹¤ passì¼ ê²½ìš°
- StencilDepthFailOp : depth fail, stencil passì¼ ê²½ìš°
- StencilFailOp : depth,stencil ë‘˜ ë‹¤ failì¼ ê²½ìš°


<br>

## Stencil Test í†µê³¼í•œ í”½ì…€ë§Œ ì²˜ë¦¬

``` cpp
dsDesc.DepthEnable = true;   
dsDesc.StencilEnable = true; // Stencil ì‚¬ìš©
dsDesc.DepthWriteMask = D3D11_DEPTH_WRITE_MASK_ALL;
dsDesc.DepthFunc = D3D11_COMPARISON_LESS_EQUAL; 
dsDesc.FrontFace.StencilFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilPassOp = D3D11_STENCIL_OP_KEEP;
dsDesc.FrontFace.StencilFunc = D3D11_COMPARISON_EQUAL; 

ThrowIfFailed(m_device->CreateDepthStencilState(
    &dsDesc, m_drawMaskedDSS.GetAddressOf()));
```

- StencilFunc = D3D11_COMPARISON_EQUAL;
  - OMSetDepthStecilState(.., 1) ì—ì„œ ì„¤ì •í•œ ê°’ 1ê³¼ ê°™ì„ ê²½ìš°ì—ë§Œ stencil test í†µê³¼í•˜ë„ë¡ ì„¤ì •
- ì°¸ê³ ë¡œ ê±°ìš¸ ì† ì„¸ìƒì„ ê·¸ë¦´ ë•Œì—ëŠ” Rasterizer Stateì˜ Clockwiseë¥¼ ë°”ê¿”ì¤˜ì•¼ í•¨(ë°˜ì‚¬ì‹œí‚¤ë©´ì„œ ccwë¡œ ë³€í˜•)

## Blending

``` cpp
D3D11_BLEND_DESC mirrorBlendDesc;

// ...

mirrorBlendDesc.RenderTarget[0].SrcBlend = D3D11_BLEND_BLEND_FACTOR;
mirrorBlendDesc.RenderTarget[0].DestBlend = D3D11_BLEND_INV_BLEND_FACTOR;
mirrorBlendDesc.RenderTarget[0].BlendOp = D3D11_BLEND_OP_ADD;

ThrowIfFailed(m_device->CreateBlendState(&mirrorBlendDesc,
                                          m_mirrorBS.GetAddressOf()));
```

- OMSetBlendState(..., blendColor, ...)
  - ì´ë•Œ ë„˜ì–´ì˜¨ colorê°’ë“¤ì´ Blend Factor
- (Source color * blend factor) + (Destination color * (1 - blend factor))
  - sourceëŠ” ê±°ìš¸ ìì²´ì˜ color
  - destinationì€ ë°˜ì‚¬ëœ ë¬¼ì²´ì˜ color


<br>



# ğŸ¥ Results

![ezgif com-crop](https://github.com/inhopp/StyleGAN/assets/96368476/534ed2f5-771b-4ddd-a671-e6d519994567)



<br>
<br>


[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}